<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Swarm Attack</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://momentjs.com/downloads/moment.js"></script>
    <script src="https://raw.githubusercontent.com/MikeMcl/decimal.js/master/decimal.js"></script>
    <!-- <script src="https://d3js.org/d3.v4.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <!-- <script src="https://code.createjs.com/1.0.0/tweenjs.min.js"></script> -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/balloon-css/balloon.min.css"
    />
    <!-- <script
      src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.5.1/q.js"
      integrity="sha512-bnuwpR6PtZyO1v+cUXlFD5zXNbPg0MGfqnUiAjM5shSWVWjrfKnqiGc4ususMaPjwvAhHOtrmYuDhfMdn8Lz2g=="
      crossorigin="anonymous"
    ></script>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   -->
    <script src="/imgtec-fullstack-challenge/js/howler.js"></script>
    <!-- <script src="/imgtec-fullstack-challenge/js/sound.js"></script> -->
    <script src="/imgtec-fullstack-challenge/js/bump.js"></script>
    <!-- loading JS assets  -->
    <script src="https://unpkg.com/@typicode/pegasus/dist/pegasus.min.js"></script>
    <script>
    var sound = new Howl({
  src: ['/imgtec-fullstack-challenge/sounds/background.mp3']
});

sound.play();
    </script>
    <style>
      /* stylesheet */
      <style type="text/css">
          .tg {
            border-collapse: collapse;
            border-color: #9abad9;
            border-spacing: 0;
          }
          .tg td {
            background-color: #ebf5ff;
            border-color: #9abad9;
            border-style: solid;
            border-width: 1px;
            color: #444;
            font-family: Arial, sans-serif;
            font-size: 14px;
            overflow: hidden;
            padding: 10px 5px;
            word-break: normal;
          }
          .tg-baqh{
            background-color: #409cff !important;
            border-color: #9abad9;
            border-style: solid;
            border-width: 1px;
            color: #fff;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: normal;
            overflow: hidden;
            padding: 10px 5px;
            word-break: normal;
            text-align: center;
            vertical-align: top;
          }
          .tg .tg-0lax {
            text-align: left;
            vertical-align: top;
          }
          .tg .tg-7zrl {
            text-align: left;
            vertical-align: bottom;
          }
        </style>
    </style>
  </head>
  <body>
    <!-- main frame -->
    <div class="row">
      <div class="col-md-2" id="score1">
      </div>
      <div class="col-md-8">
        <center>
          <!-- wartime counter -->
           <font id="counter" style="color:red;float:left;"></font>
        <font style="font-size:20px;"><b><u>Playground</u></b></font>
        <font style="font-size:12px"></font><a href="https://github.com/Grv-Singh/imgtec-fullstack-challenge">about..</a></font>
        <!-- <font style="float:right;"><i>On each tick, the bee starts to die and therefore shades away from playground   </i></font> -->
        </center>
        <!-- playground to emulate fight -->
        <div id="playground" class="row"></div>
        <div class="row">
          <center>
            <a href="#" onclick="window.location.reload();" class="myButton">Randomise ðŸ”€ </a>
            <style>
              .myButton {
                box-shadow: 0px 10px 14px -7px #276873;
                background: linear-gradient(
                  to bottom,
                  #599bb3 5%,
                  #408c99 100%
                );
                background-color: #599bb3;
                border-radius: 8px;
                display: inline-block;
                cursor: pointer;
                color: #ffffff;
                font-family: Arial;
                font-size: 20px;
                font-weight: bold;
                padding: 13px 32px;
                text-decoration: none;
                text-shadow: 0px 1px 0px #3d768a;
              }
              .myButton:hover {
                background: linear-gradient(
                  to bottom,
                  #408c99 5%,
                  #599bb3 100%
                );
                background-color: #408c99;
              }
              .myButton:active {
                position: relative;
                top: 1px;
              }
            </style>
          </center>
        </div>
      </div>
      <!-- music -->
      <div class="col-md-2" id="score2">
        <iframe src="/imgtec-fullstack-challenge/sounds/background.mp3" allow="autoplay" style="display:none" id="iframeAudio"></iframe>
      </div>
    </div>
    <script>
      // maintaining sprites
      var spritesA = [], spritesB = [];
      // scores data structure
let b = new Bump(PIXI);
      let loader = PIXI.loader,
        resources = PIXI.loader.resources,
        TextureCache = PIXI.utils.TextureCache,
        Sprite = PIXI.Sprite,
        Rectangle = PIXI.Rectangle;
      let app = new PIXI.Application({
        width: 1024,
        height: 704,
        antialias: true, 
        transparent: true,
        resolution: 1, 
        forceCanvas: true,
      });
      // making window
      document.getElementById("playground").appendChild(app.view);

      loader.add("vectors/sprites/bees.json").load(setup);
// getting shaders
      let style = new PIXI.TextStyle({
        fontFamily: "Arial",
        fontSize: 36,
        fill: "white",
        stroke: "#ff3300",
        strokeThickness: 4,
        dropShadow: true,
        dropShadowColor: "#000000",
        dropShadowBlur: 4,
        dropShadowAngle: Math.PI / 6,
        dropShadowDistance: 6,
      });

      let message = new PIXI.Text("Fight to survive !", style);
      message.position.set(250, 500);
      app.stage.addChild(message);
      app.renderer.autoDensity = true;

      var queenA, queenB, id;
      var blobAWo, blobBWo, blobA, blobB;
      let state = play;
      // setup of drawings
      function setup() {
        id = loader.resources["vectors/sprites/bees.json"].textures;
        queenA = new Sprite(
          loader.resources["vectors/sprites/bees.json"].textures[
            "Queen_bee_A.png"
          ]
        );

        queenB = new Sprite(
          loader.resources["vectors/sprites/bees.json"].textures[
            "Queen_bee_B.png"
          ]
        );
        // random direction movement
queenA.vx = randomInt(-1,1) ;
queenB.vx = randomInt(-1,1) ;
queenA.vy = randomInt(-1,1) ;
queenB.vy = randomInt(-1,1) ;
        queenA.y = 212;
        queenA.x = 10;

        queenB.x = 900;
        queenB.y = 212;
// add sprites to board
        app.stage.addChild(queenB);
        app.stage.addChild(queenA);
        spritesA.push(queenA);
        spritesB.push(queenB);
        let numberOfBlobs = 15,
          spacing = 48,
          xOffset = 150;
        for (let i = 0; i < numberOfBlobs; i++) {
          blobA = new Sprite(id["Warrior_bee_A.png"]);
          blobB = new Sprite(id["Warrior_bee_B.png"]);
          
          blobA.vx = 1 ;
blobB.vx = randomInt(-1,1) ;
blobA.vy = randomInt(-1,1) ;
blobB.vy = randomInt(-1,1) ;
          let xA = spacing * i + xOffset;
          let yA = randomInt(0, app.stage.height - blobA.height);

          let xB = spacing * i + xOffset;
          let yB = randomInt(0, app.stage.height - blobB.height);
          blobA.x = xA;
          blobA.y = yA;
          blobB.x = xB;
          blobB.y = yB;
          app.stage.addChild(blobA);
          app.stage.addChild(blobB);
          spritesA.push(blobA);
          spritesB.push(blobB);
        }
        app.ticker.add((delta) => gameLoop(delta));
        let numberOfBlobsWo = 20,
          spacingWo = 48,
          xOffsetWo = 150;
        for (let i = 0; i < numberOfBlobsWo; i++) {
          blobAWo = new Sprite(id["Worker_bee_A.png"]);
          blobBWo = new Sprite(id["Worker_bee_B.png"]);
blobAWo.vx = randomInt(-1,1) ;
blobBWo.vx = randomInt(-1,1) ;
blobAWo.vy = randomInt(-1,1) ;
blobBWo.vy = randomInt(-1,1) ;
          //`xOffset` determines the point from the left of the screen
          let xA = spacingWo * i + xOffsetWo;
          //(`randomInt` is a custom function - see below)
          let yA = randomInt(0, app.stage.height - blobAWo.height);

          let xB = spacingWo * i + xOffsetWo;
          //(`randomInt` is a custom function - see below)
          let yB = randomInt(0, app.stage.height - blobBWo.height);
          blobAWo.x = xA;
          blobAWo.y = yA;
          // blobAWo.vy = 0;
          blobBWo.x = xB;
          blobBWo.y = yB;
          // blobAWo.vy = 0;
          app.stage.addChild(blobAWo);
          app.stage.addChild(blobBWo);
          spritesA.push(blobAWo);
          spritesB.push(blobBWo);
        }

// looping the logic in game
        app.ticker.add((delta) => gameLoop(delta));
        setTimeout(function(){
if(scoreA[1][1] <= 0){
message.text = "Queen A dead, Swarm B wins!";
window.location.reload();
return false;
        }
        if(scoreB[1][1] <= 0){
message.text = "Queen B dead, Swarm A wins!";
window.location.reload();
return false;
        }
        }, 13000);
      }
      function gameLoop(delta) {
        state(delta);
      }
let hit = false;

      function play(delta) {
        for(i=0;i<spritesB.length;i++){
          // rotation to get bee effect

        if(spritesB[i].x>=1024 || spritesB[i].x <=0){
          spritesB[i].vx *=-1;
          spritesB[i].rotation += 1;
        }
        if(spritesB[i].y<=0 || spritesB[i].y >=704){
          spritesB[i].vy *=-1;
          spritesB[i].rotation += 1;
        }
          // spritesB[i].vy = 1;
        
        spritesB[i].x += (spritesB[i].vx*3);
        spritesB[i].y += (spritesB[i].vy*3);
        }
        for(j=0;j<spritesA.length;j++){
          // rotation to get bee effect

if(spritesA[j].x>=1024 || spritesA[j].x <=0){
          spritesA[j].vx *=-1;
          spritesA[j].rotation += 1;
        }
        if(spritesA[j].y<=0 || spritesA[j].y >=704){
          spritesA[j].vy *=-1;
          spritesA[j].rotation += 1;
        }
        
        spritesA[j].x -= (spritesA[j].vx*3);
        spritesA[j].y -= (spritesA[j].vy*3);
        }
        
        for (let i = 0; i < spritesA.length; i++) {
  var c1 = spritesA[i];
  for (let j = i + 1; j < spritesB.length; j++) {
    let c2 = spritesB[j];
    if (b.hit(c1, c2, true, true)) {     
      // getting metadata of the 2 bees fighting     
          let character1 = (c1._texture.textureCacheIds[0]).split('_')[0];
          let swarm1 = ((c1._texture.textureCacheIds[0]).split('_')[2]).split('.')[0];
          let character2 = (c2._texture.textureCacheIds[0]).split('_')[0];
          let swarm2 = ((c2._texture.textureCacheIds[0]).split('_')[2]).split('.')[0];
          let damageA = 0,damageB = 0;
          message.text = (character1 + ' ' + swarm1 +' v/s ' + character2 + ' ' + swarm2);
          if(swarm2!=swarm1){
            switch(character1){
              case 'Warrior': damageA = 6; damageB = 6; c2.alpha -= 1/50;
                break;
              case 'Worker' : damageA = 3; damageB = 3; c2.alpha -= 1/5;
                break;
              case 'Queen' : damageA = 1; damageB = 1; c2.alpha -= 1/10;
                break;
            }
            switch(character2){
              case 'Warrior': damageA = 6; damageB = 6; c1.alpha -= 1/50;
                break;
              case 'Worker' : damageA = 3; damageB = 3; c1.alpha -= 1/5;
                break;
              case 'Queen' : damageA = 1; damageB = 1; c1.alpha -= 1/10;
                break;
            }
            if(scoreA[parseInt(getKeyByValue(spritesA,c1))+1][1] >= 0){
          scoreA[parseInt(getKeyByValue(spritesA,c1))+1][1]-=damageB;
          scoreA[parseInt(getKeyByValue(spritesA,c1))+1][2]+=1;
            }else{
              if(scoreA[parseInt(getKeyByValue(spritesA,c1))+1][1] <= 0){
                c1.alpha = 0;
              }
            }
            
            if(scoreB[parseInt(getKeyByValue(spritesB,c2))+1][1] >= 0){
          scoreB[parseInt(getKeyByValue(spritesB,c2))+1][1]-=damageA;
          scoreB[parseInt(getKeyByValue(spritesB,c2))+1][2]+=1;
            }else{
              if(scoreB[parseInt(getKeyByValue(spritesB,c2))+1][1] <= 0){
                c2.alpha = 0;
              }
            }
          update();
          }
        }
        
        }
  }

  

}


function getKeyByValue(object, value) {
  return Object.keys(object).find(key => object[key] === value);
}
        
function update() {
  // update scores
          updateTable(scoreA, "score1");
          updateTable(scoreB, "score2");  
}
// random number genarator
      function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      // scoreboard
      var scoreA = [
        ["Role","Health","Hits"],
        ["Queen", 50, 0],
        ["Warrior1", 10, 0],
        ["Warrior2", 10, 0],
        ["Warrior3", 10, 0],
        ["Warrior4", 10, 0],
        ["Warrior5", 10, 0],
        ["Warrior6", 10, 0],
        ["Warrior7", 10, 0],
        ["Warrior8", 10, 0],
        ["Warrior9", 10, 0],
        ["Warrior10", 10, 0],
        ["Warrior11", 10, 0],
        ["Warrior12", 10, 0],
        ["Warrior13", 10, 0],
        ["Warrior14", 10, 0],
        ["Warrior15", 10, 0],
        ["Worker1", 5, 0],
        ["Worker2", 5, 0],
        ["Worker3", 5, 0],
        ["Worker4", 5, 0],
        ["Worker5", 5, 0],
        ["Worker6", 5, 0],
        ["Worker7", 5, 0],
        ["Worker8", 5, 0],
        ["Worker9", 5, 0],
        ["Worker10", 5, 0],
        ["Worker11", 5, 0],
        ["Worker12", 5, 0],
        ["Worker13", 5, 0],
        ["Worker14", 5, 0],
        ["Worker15", 5, 0],
        ["Worker10", 5, 0],
        ["Worker11", 5, 0],
        ["Worker12", 5, 0],
        ["Worker13", 5, 0],
        ["Worker14", 5, 0],
        ["Worker15", 5, 0],
        ["Worker16", 5, 0],
        ["Worker17", 5, 0],
        ["Worker18", 5, 0],
        ["Worker19", 5, 0],
        ["Worker20", 5, 0],
      ];

      var scoreB = [
        ["Role","Health","Hits"],
        ["Queen", 50, 0],
        ["Warrior1", 10, 0],
        ["Warrior2", 10, 0],
        ["Warrior3", 10, 0],
        ["Warrior4", 10, 0],
        ["Warrior5", 10, 0],
        ["Warrior6", 10, 0],
        ["Warrior7", 10, 0],
        ["Warrior8", 10, 0],
        ["Warrior9", 10, 0],
        ["Warrior10", 10, 0],
        ["Warrior11", 10, 0],
        ["Warrior12", 10, 0],
        ["Warrior13", 10, 0],
        ["Warrior14", 10, 0],
        ["Warrior15", 10, 0],
        ["Worker1", 5, 0],
        ["Worker2", 5, 0],
        ["Worker3", 5, 0],
        ["Worker4", 5, 0],
        ["Worker5", 5, 0],
        ["Worker6", 5, 0],
        ["Worker7", 5, 0],
        ["Worker8", 5, 0],
        ["Worker9", 5, 0],
        ["Worker10", 5, 0],
        ["Worker11", 5, 0],
        ["Worker12", 5, 0],
        ["Worker13", 5, 0],
        ["Worker14", 5, 0],
        ["Worker15", 5, 0],
        ["Worker10", 5, 0],
        ["Worker11", 5, 0],
        ["Worker12", 5, 0],
        ["Worker13", 5, 0],
        ["Worker14", 5, 0],
        ["Worker15", 5, 0],
        ["Worker16", 5, 0],
        ["Worker17", 5, 0],
        ["Worker18", 5, 0],
        ["Worker19", 5, 0],
        ["Worker20", 5, 0],
      ];
      // reupdate the table 
      function updateTable(tableData, id) {
        document.getElementById(id).innerHTML = "";
        var table = document.createElement("table");
        var header = table.createTHead();
        var rowH = header.insertRow(0);
  var cellH = rowH.insertCell(0);
  cellH.setAttribute("colspan","3");
  cellH.setAttribute("class","tg-baqh");
  cellH.innerHTML = (id=="score1"?"<font style='color:brown;'><b>Swarm A</b></font>":"<font style='color:lime;'><b>Swarm B</b></font>");
        table.setAttribute("class", "tg");
        table.setAttribute("id", id+"H");
        var tableBody = document.createElement("tbody");
        tableData.forEach(function (rowData) {
          var row = document.createElement("tr");
          rowData.forEach(function (cellData) {
            var cell = document.createElement("td");
            cell.setAttribute("class", "tg-0lax");
            cell.appendChild(document.createTextNode(cellData));
            row.appendChild(cell);
          });

          tableBody.appendChild(row);
        });

        table.appendChild(tableBody);
        document.getElementById(id).appendChild(table);
      }

      updateTable(scoreA, "score1");
      updateTable(scoreB, "score2");

    const seconds = document.querySelector("#counter");
    let count = 0;
// counter
    const renderTimer = () => {
      count += 1;
      seconds.innerHTML = "Wartime: "+ (count % 60).toString().padStart(2, "0") + " seconds";
    }

    const timer = setInterval(renderTimer, 1000);

    </script>
  </body>
</html>
